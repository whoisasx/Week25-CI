name: Turborepo CI/CD Pipeline

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: 📥 Checkout Repo
              uses: actions/checkout@v3

            - name: 🔐 Setup SSH key
              run: |
                  echo "${{ secrets.DEV_SSH_KEY }}" > deploy_key.pem
                  chmod 600 deploy_key.pem

            - name: 🚀 Deploy on Google VM
              run: |
                  ssh -o StrictHostKeyChecking=no -i deploy_key.pem ${{ secrets.DEV_VM_USERNAME }}@${{ secrets.DEV_VM_HOST }} << 'EOF'
                    export NVM_DIR="\$HOME/.nvm"
                    [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                    nvm use node
                    export PATH="\$(npm bin -g):\$PATH"

                    echo "🧠 Whoami: \$(whoami)"
                    echo "📂 Current Directory: \$(pwd)"
                    echo "📃 PATH: \$PATH"
                    echo "🧪 Node: \$(node -v)"
                    echo "📦 NPM: \$(npm -v)"
                    echo "😊 PNPM: \$(pnpm -v)"

                    echo "🛠️ Ensuring pnpm is installed..."
                    if ! command -v pnpm &> /dev/null; then
                      echo "📦 Installing pnpm..."
                      npm install -g pnpm
                    else
                      echo "✅ pnpm already installed"
                    fi

                    echo "🚀 PNPM: \$(pnpm -v)"

                    echo "📁 Navigating to project directory..."
                    cd /home/${{ secrets.DEV_VM_USERNAME }}/desktop/Week25-CI

                    echo "🔄 Resetting repo to match remote main..."
                    git fetch origin main
                    git reset --hard origin/main

                    echo "📦 Installing dependencies..."
                    pnpm install

                    echo "🔐 Setting up DB environment..."
                    cp /home/${{ secrets.DEV_VM_USERNAME }}/.env ./packages/db/.env

                    echo "🛠️ Generating Prisma client..."
                    pnpm -F db exec prisma generate

                    echo "🧱 Building DB package..."
                    pnpm --filter db build

                    echo "🏗️ Building all apps..."
                    pnpm build

                    echo "🧹 Removing old PM2 processes (if any)..."
                    pm2 delete web-app || true
                    pm2 delete http-api || true
                    pm2 delete ws-server || true

                    echo "🚀 Starting apps using PM2..."
                    pm2 start apps/web/.output/server/index.mjs --name web-app
                    pm2 start apps/api/dist/index.js --name http-api
                    pm2 start apps/ws/dist/index.js --name ws-server

                    echo "💾 Saving PM2 process list for restart on reboot..."
                    pm2 save

                    echo "✅ Deployment complete!"
                  EOF
