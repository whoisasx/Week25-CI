name: Turborepo CI/CD Pipeline

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout Repo
              uses: actions/checkout@v3

            - name: ğŸ” Setup SSH key
              run: |
                  echo "${{ secrets.DEV_SSH_KEY }}" > deploy_key.pem
                  chmod 600 deploy_key.pem
            - name: ğŸš€ Deploy on Google VM
              run: |
                  ssh -t -o StrictHostKeyChecking=no -i deploy_key.pem ${{ secrets.DEV_VM_USERNAME }}@${{ secrets.DEV_VM_HOST }} "bash -l -i" <<'EOF'
                    echo "ğŸ”„ Sourcing nvm..."
                    export NVM_DIR="\$HOME/.nvm"
                    [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
                    echo "ğŸ“¦ Using default Node..."
                    nvm use node
                    echo "ğŸ§ª Checking Node and NPM..."
                    echo "Node: \$(node -v || echo 'âŒ Not Found')"
                    echo "NPM: \$(npm -v || echo 'âŒ Not Found')"
                    if ! command -v npm &> /dev/null; then
                      echo "ğŸ“¥ Installing npm..."
                      nvm install-latest-npm
                    fi
                    echo "ğŸš€ Ensuring pnpm is installed..."
                    if ! command -v pnpm &> /dev/null; then
                      echo "ğŸ“¦ Installing pnpm..."
                      npm install -g pnpm
                    fi
                    echo "ğŸ”§ Ensuring git is installed..."
                    if ! command -v git &> /dev/null; then
                      echo "ğŸ“¦ Installing git..."
                      sudo apt update && sudo apt install -y git
                    fi
                    echo "ğŸ§° Ensuring pm2 is installed..."
                    if ! command -v pm2 &> /dev/null; then
                      echo "ğŸ“¦ Installing pm2..."
                      npm install -g pm2
                    fi
                    echo "ğŸ“ Navigating to project directory..."
                    cd /home/${{ secrets.DEV_VM_USERNAME }}/desktop/Week25-CI
                    echo "ğŸ”„ Resetting repo to match remote main..."
                    git fetch origin main
                    git reset --hard origin/main
                    echo "ğŸ“¦ Installing dependencies..."
                    pnpm install
                    echo "ğŸ” Setting up DB environment..."
                    cp /home/${{ secrets.DEV_VM_USERNAME }}/.env ./packages/db/.env
                    echo "ğŸ› ï¸ Generating Prisma client..."
                    pnpm -F db exec pnpx prisma generate --schema=prisma/schema.prisma
                    echo "ğŸ§± Building DB package..."
                    pnpm --filter db build
                    echo "ğŸ—ï¸ Building all apps..."
                    pnpm build
                    echo "ğŸ§¹ Removing old PM2 processes (if any)..."
                    pm2 delete web-app || true
                    pm2 delete http-server || true
                    pm2 delete ws-server || true
                    echo "ğŸš€ Starting apps using PM2..."
                    pm2 start "pnpm --filter web start" --name web-app
                    [ -f apps/http-server/dist/index.js ] && pm2 start apps/http-server/dist/index.js --name http-server || echo "âŒ http-server entry not found"
                    [ -f apps/ws-server/dist/index.js ] && pm2 start apps/ws-server/dist/index.js --name ws-server || echo "âŒ ws-server entry not found"
                    echo "ğŸ’¾ Saving PM2 process list for restart on reboot..."
                    pm2 save
                    echo "âœ… Deployment complete!"
                    exit 0
                    EOF
