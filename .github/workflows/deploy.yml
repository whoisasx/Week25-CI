name: Turborepo CI/CD Pipeline

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout Repo
              uses: actions/checkout@v3

            - name: ğŸ§‘â€ğŸ’» Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version: 18
                  cache: "pnpm"

            - name: ğŸ§© Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 8
                  run_install: false

            - name: ğŸ”§ Add pnpm to PATH
              run: echo "${PNPM_HOME}" >> $GITHUB_PATH

            - name: ğŸ” Setup SSH Agent
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.DEV_SSH_KEY }}

            - name: ğŸš€ Deploy on Google VM
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.DEV_VM_USERNAME }}@${{ secrets.DEV_VM_HOST }} << 'EOF'
                    set -e

                    echo "ğŸ“ Navigating to project directory..."
                    cd /home/${{ secrets.DEV_VM_HOST }}/desktop/Week25-CI

                    echo "ğŸ”„ Resetting repo to match remote main..."
                    git fetch origin main
                    git reset --hard origin/main

                    echo "ğŸ“¦ Installing dependencies..."
                    pnpm install

                    echo "ğŸ” Setting up DB environment..."
                    cp /home/${{ secrets.DEV_VM_USERNAME }}/.env ./packages/db/.env

                    echo "ğŸ› ï¸ Generating Prisma client..."
                    pnpm -F db exec prisma generate

                    echo "ğŸ§± Building DB package..."
                    pnpm --filter db build

                    echo "ğŸ—ï¸ Building all apps..."
                    pnpm build

                    echo "ğŸ§¹ Removing old PM2 processes (if any)..."
                    pm2 delete web-app || true
                    pm2 delete http-api || true
                    pm2 delete ws-server || true

                    echo "ğŸš€ Starting apps using PM2..."
                    pm2 start apps/web/.output/server/index.mjs --name web-app
                    pm2 start apps/api/dist/index.js --name http-api
                    pm2 start apps/ws/dist/index.js --name ws-server

                    echo "ğŸ’¾ Saving PM2 process list for restart on reboot..."
                    pm2 save

                    echo "âœ… Deployment complete!"
                  EOF
